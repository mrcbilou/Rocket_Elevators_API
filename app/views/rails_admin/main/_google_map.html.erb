<script src="//maps.google.com/maps/api/js?key=<%= "#{ENV['GOOGLE_MAPS']}" %>"></script>  
<script src="//cdn.rawgit.com/mahnunchik/markerclustererplus/master/dist/markerclusterer.min.js"></script>  
<script src='//cdn.rawgit.com/printercu/google-maps-utility-library-v3-read-only/master/infobox/src/infobox_packed.js' type='text/javascript'></script>
<script src='//underscorejs.org/underscore-min.js' type='text/javascript'></script>

<%=
    @data = Gmaps4rails.build_markers(Building.all) do |b, marker|
        totalFloor = 0
        columns = Column.where(battery_id: b.id)

        for c in columns do
            totalFloor += c.number_of_floors_served
        end

        a = Geocoder.search("#{Address.find(b.id).number_and_street.split(" ")[1]}, #{Address.find(b.id).city}, USA")

        marker.lat a.first.coordinates[0]
        marker.lng a.first.coordinates[1]
        marker.picture({
            "width": 32,
            "height": 32
        })
        marker.infowindow "This is the Building ##{b.id},\nThe Building has a total of #{totalFloor} of floors,\n"
    end

    @data = raw @data.to_json
%>

<div class="container">
    <div class="row">
        <div style='width: 800px;'>
            <div id="map" style='width: 1200px; height: 400px;'></div>  
        </div>

        <script type="text/javascript">
            handler = Gmaps.build('Google');
            handler.buildMap({ provider: {}, internal: {id: 'map'}}, function(){
                markers = handler.addMarkers(<%= @data %>);
                handler.bounds.extendWith(markers);
                handler.fitMapToBounds();
            });
        </script>
    </div>
</div>